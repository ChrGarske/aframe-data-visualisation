<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>webVR Data Visualization</title>
  <meta name="DataVisTest">
  <link rel="shortcut icon" href="">
  <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
  <script> // Script prototype for events when hovering with the cursor over an object
    AFRAME.registerComponent('data_cursorlistener', {
      schema: {
        axis: { default: 'x' }
      },
      init: function () {
        var compdata = this.data;
        this.el.addEventListener('click', function () {
          var plotdata = window.value;
          var idx = this.parentNode.parentNode.getAttribute("value");
          var plotID = document.getElementById('plotbox' + idx);
          var geo = plotID.getAttribute("geometry");
          var range = [];
          switch (compdata.axis) {
            case 'x':
              range = [0, geo.width];
              break;
            case 'y':
              range = [0, geo.height];
              break;
            case 'z':
              range = [0, geo.depth];
          }
          var origin = d3.select('#origin' + idx);
          var mappedArray = d3.entries(plotdata[0]),
            key = this.getAttribute("id"),
            extent = d3.extent(plotdata, function (d) { return +d[key]; });
          var scale = d3.scaleLinear()
            .domain(extent)
            .range(range);
          console.log(colorScale);
          var selection = origin.selectAll('a-sphere')
            .data(plotdata);
          selection.enter().append('a-sphere')
            .attr('radius', 0.03)
            .attr('color', 'black')
            .attr('position', '0 0 0')
            .attr('animation', function (d) {
              return 'property: position; to: ' + scale(d[key]) + ' 0 0;dur:1500;easing:linear';
            })
          if (compdata.axis=='z'){
            var colorScale = d3.scaleSequential()
              .domain(extent)
              .interpolator(d3.interpolateInferno);
            selection.attr("color",function(d){return colorScale(d[key]);});
          }
          selection.attr('animation', function (d) {
            var pos = '0 0 0';
            switch (compdata.axis) {
              case 'x':
                pos = scale(d[key]) + ' ' + d3.select(this).attr("position").y + ' ' + d3.select(this).attr("position").z;
                break;
              case 'y':
                pos = d3.select(this).attr("position").x + ' ' + scale(d[key]) + ' ' + d3.select(this).attr("position").z;
                break;
              case 'z':
                pos = d3.select(this).attr("position").x + ' ' + d3.select(this).attr("position").y + ' ' + scale(d[key]);
            }
            //console.log(pos);
            return 'property: position; to: ' + pos + ';dur:1500;easing:linear';
          });
        });
      }
    });
  </script>

  <script> // cursor listener for the show button 
    AFRAME.registerComponent('show_cursorlistener', {
      init: function () {
        this.el.addEventListener('click', function () {
          var val = this.parentNode.getAttribute('value')
          this.parentNode.querySelector('#x' + val).setAttribute('visible', 'true');
          this.parentNode.querySelector('#x' + val).setAttribute('class', 'clickable');
          this.parentNode.querySelector('#y' + val).setAttribute('visible', 'true');
          this.parentNode.querySelector('#y' + val).setAttribute('class', 'clickable');
          this.parentNode.querySelector('#z' + val).setAttribute('visible', 'true');
          this.parentNode.querySelector('#z' + val).setAttribute('class', 'clickable');
          // create subplane to show the graph on
          if (!document.getElementById("plotbox" + val)) {
            var plotbox = document.createElement("a-box");
            plotbox.setAttribute("id", "plotbox" + val);
            console.log("plotbox created");
          } else {
            console.log("plotbox selected")
            var plotbox = document.getElementById("plotbox" + val);
          }
          plotbox.setAttribute("position", { x: -.5, y: 0, z: .055 });
          plotbox.setAttribute("geometry", "height:5");
          plotbox.setAttribute("geometry", "width:5");
          plotbox.setAttribute("geometry", "depth:.1");
          plotbox.setAttribute("material", "color:green");
          plotbox.setAttribute("material", "opacity:.1");
          plotbox.setAttribute("class","not-clickable");
          d3.csv("simulated_data_2_random_2000.csv", type, function (error, data) {
            window.value = data;
          });
          //append everything
          this.parentNode.appendChild(plotbox);
        });
      }
    });
    function type(d) {
      d.value = +d.value;
      return d;
    };
  </script>
  <script> // cursor listener for the hide button
    AFRAME.registerComponent('hide_cursorlistener', {
      init: function () {
        this.el.addEventListener('click', function () {
          this.parentNode.querySelector('#x').setAttribute('visible', 'false');
          this.parentNode.querySelector('#x').removeAttribute('class', 'clickable');
          this.parentNode.querySelector('#y').setAttribute('visible', 'false');
          this.parentNode.querySelector('#y').removeAttribute('class', 'clickable');
          this.parentNode.querySelector('#z').setAttribute('visible', 'false');
          this.parentNode.querySelector('#z').removeAttribute('class', 'clickable');
        });
      }
    });
  </script>
  <script> // cursor listener for the x axis
    AFRAME.registerComponent('x_cursorlistener', {
      schema:{
        on: {type:'boolean',default: false}
      },
      init: function () {
        var switched = this.data;
        var idx = this.el.parentNode.getAttribute("value");  this.el.addEventListener('click', function () {
          if (switched.on){
            switched.on = false;
            var buttonchildren = d3.select(this).selectAll(".clickable")
            buttonchildren.attr('animation','property:position;to: 0 0 0;dur:1500;easing:linear');
            setTimeout(function(){
                buttonchildren.remove();
                document.getElementById("x" + idx).setAttribute("material", "color:gray");
              },1500
            );
          }else{ 
          switched.on = true;
          var plotID = document.getElementById('plotbox' + idx);
          var geo = plotID.getAttribute("geometry");
          d3.select(plotID).append('a-entity')
            .attr('id', 'origin' + idx)
            .attr('position', (-geo.width / 2) + ' ' + (-geo.height / 2) + ' 0');
          var origin = d3.select('#origin' + idx);
          //actual plotting
          var xshift = 0;
          var yshift = 0;
          var data = window.value;
          d3.entries(data[0]).forEach(function (d) {
            if (d.key != "" && d.key != "sample_id") {
              xshift++;
              if (xshift > 5) {
                xshift = 1;
                yshift = yshift - 0.75;
              }
              var button = document.createElement('a-entity');
              button.setAttribute('geometry', 'primitive: box');
              button.setAttribute("geometry", { height: .5, width: .5, depth: .08 });
              button.setAttribute('animation', 'property:position;to: ' + xshift + ' ' + yshift + ' 0;dur:1500;easing:linear');
              button.setAttribute('material', 'color', 'grey');
              button.setAttribute('data_cursorlistener', 'axis: ' + document.getElementById("x" + idx).getAttribute('value'));
              button.setAttribute('onclick', 'event.stopPropagation()');
              button.setAttribute('id', d.key);
              button.setAttribute('class', 'clickable');
              var buttontext = document.createElement('a-text');
              buttontext.setAttribute('value', d.key);
              buttontext.setAttribute('color', 'black');
              buttontext.setAttribute('align', 'center');
              buttontext.setAttribute('position', { x: 0, y: 0, z: .045 });
              button.appendChild(buttontext);
              document.getElementById("x" + idx).appendChild(button);
              document.getElementById("x" + idx).setAttribute("material", "color:green");
            }
          });
          origin.attr("line__x",'start:0 0 0; end: '+ geo.width + ' 0 0;color:gray');
          }
        });
      }
    });
    function type(d) {
      d.value = +d.value;
      return d;
    };
  </script>
  <script> // cursor listener for the y axis
    AFRAME.registerComponent('y_cursorlistener', {
      schema:{
        on: {type:'boolean',default: false}
      },
      init: function () {
        var switched = this.data;
        var idx = this.el.parentNode.getAttribute("value");
        this.el.addEventListener('click', function () {
          if (switched.on){
            switched.on = false;
            var buttonchildren = d3.select(this).selectAll(".clickable")
            buttonchildren.attr('animation','property:position;to: 0 0 0;dur:1500;easing:linear');
            setTimeout(function(){
                buttonchildren.remove();
                document.getElementById("y" + idx).setAttribute("material", "color:gray");
              },1500
            );
          }else{ 
          switched.on = true;
          var plotID = document.getElementById('plotbox' + idx);
          var geo = plotID.getAttribute("geometry");
          var yRange = [0, geo.height];
          var origin = d3.select('#origin' + idx);
          //actual plotting
          var xshift = 0;
          var yshift = 0;
          var data = window.value;
          d3.entries(data[0]).forEach(function (d) {
            if (d.key != "" && d.key != "sample_id") {
              yshift--;
              if (yshift < -5) {
                xshift = xshift + 0.75;
                yshift = -1;
              }
              var button = document.createElement('a-entity');
              button.setAttribute('geometry', 'primitive: box');
              button.setAttribute("geometry", { height: .5, width: .5, depth: .08 });
              button.setAttribute('animation', 'property:position;to: ' + xshift + ' ' + yshift + ' 0;dur:1500;easing:linear');
              button.setAttribute('material', 'color', 'grey');
              button.setAttribute('data_cursorlistener', 'axis: ' + document.getElementById("y" + idx).getAttribute('value'));
              button.setAttribute('onclick', 'event.stopPropagation()');
              button.setAttribute('id', d.key);
              button.setAttribute('class', 'clickable');
              var buttontext = document.createElement('a-text');
              buttontext.setAttribute('value', d.key);
              buttontext.setAttribute('color', 'black');
              buttontext.setAttribute('align', 'center');
              buttontext.setAttribute('position', { x: 0, y: 0, z: .045 });
              button.appendChild(buttontext);
              document.getElementById("y" + idx).appendChild(button);
              document.getElementById("y" + idx).setAttribute("material", "color:green");
            }
          });
          origin.attr("line__y",'start:0 0 0; end: 0 '+ geo.height + ' 0;color:gray');
          }
        });
      }
    });
    function type(d) {
      d.value = +d.value;
      return d;
    };
  </script>
  <script> // cursor listener for the z axis
    AFRAME.registerComponent('z_cursorlistener', {
      schema:{
        on: {type:'boolean',default: false}
      },
      init: function () {
        var switched = this.data;
        var idx = this.el.parentNode.getAttribute("value");
        this.el.addEventListener('click', function () {
          if (switched.on){
            switched.on = false;
            var buttonchildren = d3.select(this).selectAll(".clickable")
            buttonchildren.attr('animation','property:position;to: 0 0 0;dur:1500;easing:linear');
            setTimeout(function(){
                buttonchildren.remove();
                document.getElementById("z" + idx).setAttribute("material", "color:gray");
              },1500
            );
          }else{ 
          switched.on = true;
          var plotID = document.getElementById('plotbox' + idx);
          plotID.setAttribute('animation__depth', 'property: geometry.depth;to: 5;dur:1500;easing:linear');
          plotID.setAttribute('animation__pos', 'property: position;to:-.5 0 2.5;dur:1500;easing:linear');
          var geo = plotID.getAttribute("geometry");
          var zRange = [0, geo.height];
          var origin = d3.select('#origin' + idx)
            .attr('animation', 'property: position;to:-2.5 -2.5 -2.5;dur:1500;easing:linear');
          //actual plotting
          var xshift = 0;
          var yshift = 0;
          var data = window.value;
          d3.entries(data[0]).forEach(function (d) {
            if (d.key != "" && d.key != "sample_id") {
              xshift++;
              if (xshift > 5) {
                xshift = 1;
                yshift = yshift + 0.75;
              }
              var button = document.createElement('a-entity');
              button.setAttribute('geometry', 'primitive: box');
              button.setAttribute("geometry", { height: .5, width: .5, depth: .08 });
              button.setAttribute('animation', 'property:position;to: ' + xshift + ' ' + yshift + ' 0;dur:1500;easing:linear');
              button.setAttribute('material', 'color', 'grey');
              button.setAttribute('data_cursorlistener', 'axis: ' + document.getElementById("z" + idx).getAttribute('value'));
              button.setAttribute('onclick', 'event.stopPropagation()');
              button.setAttribute('id', d.key);
              button.setAttribute('class', 'clickable');
              var buttontext = document.createElement('a-text');
              buttontext.setAttribute('value', d.key);
              buttontext.setAttribute('color', 'black');
              buttontext.setAttribute('align', 'center');
              buttontext.setAttribute('position', { x: 0, y: 0, z: .045 });
              button.appendChild(buttontext);
              document.getElementById("z" + idx).appendChild(button);
              document.getElementById("z" + idx).setAttribute("material", "color:green");
            }
          });
          setTimeout(function() {
            origin.attr("line__z",'start:0 0 0; end: 0 0 '+ geo.depth+ ';color:gray');
          },1500);
          }
        });
      }
    });
    function type(d) {
      d.value = +d.value;
      return d;
    };
  </script>
  <!-- <script>
             
              plotID.setAttribute("line__z",'start:'+ (-geo.width/2) + ' ' + (-geo.height/2) + ' ' + (-d3.select('#plotbox4').attr("geometry").depth/2)+'; end: '+ (-geo.width/2) + ' ' + (-geo.height/2) + ' ' + (d3.select('#plotbox4').attr("geometry").depth/2)+';color:black');
              </script> -->
  <script> // script for the creation of an octagonal "room"
    AFRAME.registerComponent('room', {
      init: function () {
        var space = document.querySelector('a-scene');
        var i;
        var w = 10,
          h = 15;
        for (i = 0; i < 8; i++) {
          var sheet = document.createElement('a-entity');
          var alpha = i / 4 * Math.PI;
          sheet.setAttribute("id", 'mycanvas' + i);
          //sheet.setAttribute('class', 'mycanvas');
          sheet.setAttribute('geometry', {
            primitive: 'plane',
            height: h,
            width: w
          });
          sheet.setAttribute('material', {
            metalness: 0,
            color: '#f0f0f0'
          });
          sheet.setAttribute('position', { x: 10 * Math.sin(alpha), y: 1, z: 10 * Math.cos(alpha) });
          sheet.setAttribute('rotation', { x: 0, y: (i - 4) / 8 * 360, z: 0 });
          sheet.setAttribute('buttons', '');
          sheet.setAttribute('value', i);
          space.appendChild(sheet);
        }
      }
    });
  </script>
  <script> // creating the buttons on the walls
    AFRAME.registerComponent('buttons', {
      init: function () {
        var val = this.el.getAttribute('value');
        var b = ["x", "y", "z", "show", "hide"];
        var bx = [0.15, 0.775, 0.15, 0.2, 0.8].map(function (x) { return 10 * (x - .5) });
        var by = [0.3, 0.65, 0.7, 0.2, 0.2].map(function (x) { return 15 * (x - .5) });
        for (j = 0; j < 5; j++) {
          var button = document.createElement('a-entity');
          button.setAttribute('id', b[j] + val);
          button.setAttribute('value', b[j]);
          button.setAttribute('geometry', {
            primitive: 'box',
            height: '.5',
            width: '1',
            depth: '.1'
          });
          button.setAttribute('material', 'color', 'grey');
          button.setAttribute('position', { x: bx[j], y: by[j], z: 0 });
          button.setAttribute(b[j] + '_cursorlistener', '');
          button.setAttribute('rotation', { x: 0, y: 0, z: 0 });
          if (j < 3) {
            button.setAttribute('visible', 'false');
          } else {
            button.setAttribute('class', 'clickable');
          }
          var buttontext = document.createElement('a-text');
          buttontext.setAttribute('value', b[j]);
          buttontext.setAttribute('color', 'black');
          buttontext.setAttribute('align', 'center');
          buttontext.setAttribute('position', { x: 0, y: 0, z: .055 });
          button.appendChild(buttontext);
          this.el.appendChild(button);
        }
      }
    });
  </script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
</head>
<style>
  text {
    font: 11px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .tick line {
    opacity: 0.2;
  }

  /* .dot {
    fill: crimson;
    stroke: #000;
  } */
</style>

<body>
  <a-scene background="color:#CECECE" room>
    <a-assets>
      <img id="wood" src="1-fine-wood-seamless.jpg">
    </a-assets>
    <a-entity camera look-controls wasd-controls>
      <a-entity
        animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.5 0.5 0.5; to: 1 1 1"
        animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.5 0.5 0.5"
        animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1"
        raycaster = "objects: .clickable" 
        cursor="fuse:true"
        position="0 0 -1"
        geometry="primitive:ring; radiusInner:0.02; radiusOuter:0.03" material="color:black; shader:flat">
      </a-entity>
    </a-entity>
    <a-sky color="cyan"> </a-sky>
    <a-plane color="black" position="0 -5 0" height="20" width="20" repeat="10 10" rotation="-90 0 0"></a-plane>
  </a-scene>
</body>

</html>