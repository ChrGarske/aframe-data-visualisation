<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <title>webVR Data Visualization</title>
  <meta name='DataVisTest'>
  <link rel='shortcut icon' href=''>
  <script src='https://aframe.io/releases/0.9.0/aframe.min.js'></script>
  <script> // data listeners
    AFRAME.registerComponent('data_cursorlistener', {
      schema: {
        axis: { default: 'x' }
      },
      init: function () {
        var compdata = this.data;
        this.el.addEventListener('click', function () {
          var plotdata = window.value;
          var idx = this.parentNode.parentNode.getAttribute('value');
          var plotID = document.getElementById('plotbox' + idx);
          var geo = plotID.getAttribute('geometry');
          var range = [];
          switch (compdata.axis) {
            case 'x':
              range = [0, geo.width];
              break;
            case 'y':
              range = [0, geo.height];
              break;
            case 'z':
              range = [0, geo.depth];
          }
          var origin = d3.select('#origin' + idx);
          var mappedArray = d3.entries(plotdata[0]),
            key = this.getAttribute('id'),
            extent = d3.extent(plotdata, function (d) { return +d[key]; });
          var scale = d3.scaleLinear()
            .domain(extent)
            .range(range);
          console.log(colorScale);
          var selection = origin.selectAll('a-sphere')
            .data(plotdata);
          selection.enter().append('a-sphere')
            .attr('radius', 0.03)
            .attr('color', 'black')
            .attr('position', '0 0 0')
            .attr('animation', function (d) {
              return 'property: position; to: ' + scale(d[key]) + ' 0 0;dur:1500;easing:linear';
            })
          if (compdata.axis == 'z') {
            var colorScale = d3.scaleSequential()
              .domain(extent)
              .interpolator(d3.interpolateInferno);
            selection.attr('color', function (d) { return colorScale(d[key]); });
          }
          selection.attr('animation', function (d) {
            var pos = '0 0 0';
            switch (compdata.axis) {
              case 'x':
                pos = scale(d[key]) + ' ' + d3.select(this).attr('position').y + ' ' + d3.select(this).attr('position').z;
                break;
              case 'y':
                pos = d3.select(this).attr('position').x + ' ' + scale(d[key]) + ' ' + d3.select(this).attr('position').z;
                break;
              case 'z':
                pos = d3.select(this).attr('position').x + ' ' + d3.select(this).attr('position').y + ' ' + scale(d[key]);
            }
            //console.log(pos);
            return 'property: position; to: ' + pos + ';dur:1500;easing:linear';
          });
        });
      }
    });
  </script>
  <script> // cursor listener for the show button 
    AFRAME.registerComponent('show_cursorlistener', {
      init: function () {
        this.el.addEventListener('click', function () {
          var val = this.parentNode.getAttribute('value')
          this.parentNode.querySelector('#x' + val).setAttribute('visible', 'true');
          this.parentNode.querySelector('#x' + val).setAttribute('class', 'clickable');
          this.parentNode.querySelector('#y' + val).setAttribute('visible', 'true');
          this.parentNode.querySelector('#y' + val).setAttribute('class', 'clickable');
          this.parentNode.querySelector('#z' + val).setAttribute('visible', 'true');
          this.parentNode.querySelector('#z' + val).setAttribute('class', 'clickable');
          // create subplane to show the graph on
          if (!document.getElementById('plotbox' + val)) {
            var plotbox = document.createElement('a-box');
            plotbox.setAttribute('id', 'plotbox' + val);
            console.log('plotbox created');
          } else {
            console.log('plotbox selected')
            var plotbox = document.getElementById('plotbox' + val);
          }
          plotbox.setAttribute('position', { x: -.5, y: 0, z: .055 });
          plotbox.setAttribute('geometry', 'height:5');
          plotbox.setAttribute('geometry', 'width:5');
          plotbox.setAttribute('geometry', 'depth:.1');
          plotbox.setAttribute('material', 'color:green');
          plotbox.setAttribute('material', 'opacity:.1');
          plotbox.setAttribute('class', 'not-clickable');
          d3.csv('simulated_data_2_random_2000.csv', type, function (error, data) {
            window.value = data;
          });
          //append everything
          this.parentNode.appendChild(plotbox);
        });
      }
    });
    function type(d) {
      d.value = +d.value;
      return d;
    };
  </script>
  <script> // cursor listener for the hide button
    AFRAME.registerComponent('hide_cursorlistener', {
      init: function () {
        this.el.addEventListener('click', function () {
          this.parentNode.querySelector('#x').setAttribute('visible', 'false');
          this.parentNode.querySelector('#x').removeAttribute('class', 'clickable');
          this.parentNode.querySelector('#y').setAttribute('visible', 'false');
          this.parentNode.querySelector('#y').removeAttribute('class', 'clickable');
          this.parentNode.querySelector('#z').setAttribute('visible', 'false');
          this.parentNode.querySelector('#z').removeAttribute('class', 'clickable');
        });
      }
    });
  </script>
  <script> // cursor listener for the axis
    // AFRAME.registerComponent('rotatePlot',{
    //   schema:{
    //     axis:{type:'string',default:'x'},
    //     nofWall:{type:'int',defualt:0}
    //   },
    //   init: function(){
    //     this.el.addEventListener('mouseenter',function() {
    //       setInterval()
    //       var plot = document.getElementById('plotbox'+nofWall);
    //       plot.setAttribute('rotation',axis,plot.getAttribute('rotation')[axis]+1);
    //     })
    //   }
    // });
    var rotate ;
    AFRAME.registerComponent('axis_cursorlistener', {
      schema: {
        axis: {type: 'string', default: 'x'},
        on: { type: 'boolean', default: false }
      },
      init: function () {
        var option = this.data;
        var idx = this.el.parentNode.getAttribute('value'); this.el.addEventListener('click', function () {
          if (option.on) {
            option.on = false;
            var buttonchildren = d3.select(this).selectAll('.clickable')
            buttonchildren.attr('animation', 'property:position;to: 0 0 0;dur:1500;easing:linear');
            setTimeout(function () {
              buttonchildren.remove();
              document.getElementById(option.axis + idx).setAttribute('material', 'color:grey');
            }, 1500
            );
          } else {
            option.on = true;
            var plotID = document.getElementById('plotbox' + idx);
            var geo = plotID.getAttribute('geometry');
            switch (option.axis){
              case 'x':
                var origin = d3.select(plotID).append('a-entity')
                .attr('id', 'origin' + idx)
                .attr('position', (-geo.width / 2) + ' ' + (-geo.height / 2) + ' 0');
                line_to = geo.width+' 0 0';
                break;
              case 'y':
                var origin = d3.select('#origin' + idx);
                line_to = '0 '+geo.height+' 0';
                break;
              case 'z':
                var origin = d3.select('#origin' + idx)
                  .attr('animation', 'property: position;to:-2.5 -2.5 -2.5;dur:1500;easing:linear');
                plotID.setAttribute('animation__depth', 'property: geometry.depth;to: 5;dur:1500;easing:linear');
                plotID.setAttribute('animation__pos', 'property: position;to:-.5 0 2.5;dur:1500;easing:linear');
                line_to = '0 0 5';
                document.getElementById('x'+idx).appendChild(buttons('x','-.3 .65 0','<',idx));
                document.getElementById('x'+idx).appendChild(buttons('x','.3 .65 0','>',idx));
                document.getElementById('y'+idx).appendChild(buttons('y','-.3 .65 0','<',idx));
                document.getElementById('y'+idx).appendChild(buttons('y','.3 .65 0','>',idx));
                document.getElementById('z'+idx).appendChild(buttons('z','-.3 .65 0','<',idx));
                document.getElementById('z'+idx).appendChild(buttons('z','.3 .65 0','>',idx));
            }
            console.log(line_to)
            //actual plotting
            var shift = [0, 0];
            var data = window.value;
            d3.entries(data[0]).forEach(function (d) {
              if (d.key != '' && d.key != 'sample_id' && d.key != 'value') {
                shift[0]++;
                if (shift[0] > 5) {
                  shift[0] = 1;
                  shift[1] = - 0.75;
                }
                // create data buttons [functions]
                var button = data_buttons(d, shft = shift, ax=option.axis);
                var btext = buttontext(d.key);
                button.appendChild(btext);
                // appending the buttons to the axis button
                document.getElementById(option.axis + idx).appendChild(button);
                document.getElementById(option.axis + idx).setAttribute('material', 'color:green');
              }
            });
            if (origin.select('line__'+option.axis).empty()){
              origin.attr('line__'+option.axis, 'start: 0 0 0; end: ' + line_to + ';color:gray');
            }
          }
        });
      }
    });
    
    function type(d) {
      d.value = +d.value;
      return d;
    };
    function data_buttons(d, shft = [0, 0], ax = 'x', c = 'grey') {
      switch (ax){
        case 'x': 
          break;
        case 'y': 
          shft = [-shft[1],-shft[0]];
          break;
        case 'z':
          shft = [shft[0],-shft[1]];
      };
      var button = document.createElement('a-entity');
      button.setAttribute('geometry', 'primitive: box');
      button.setAttribute('geometry', { height: .5, width: .5, depth: .08 });
      button.setAttribute('animation', 'property:position;to: ' + shft[0] + ' ' + shft[1] + ' 0;dur:1500;easing:linear');
      button.setAttribute('material', 'color', c);
      button.setAttribute('data_cursorlistener', 'axis: ' + ax);
      button.setAttribute('onclick', 'event.stopPropagation()');
      button.setAttribute('id', d.key);
      button.setAttribute('class', 'clickable');
      return button;
    };
    function buttontext(text, c = 'black') {
      var buttontext = document.createElement('a-text');
      buttontext.setAttribute('value', text);
      buttontext.setAttribute('color', c);
      buttontext.setAttribute('align', 'center');
      buttontext.setAttribute('position', { x: 0, y: 0, z: .045 });
      return buttontext;
    }
    function buttons(ax='x',pos='0 0 0',txt='',idx=0){
      var b = document.createElement('a-entity');
      b.setAttribute('id',ax+txt);
      b.setAttribute('geometry','primitive:box;height:.3;width:.3;depth:.08');
      b.setAttribute('material','color','grey');
      b.setAttribute('class','clickable');
      b.setAttribute('onclick', 'event.stopPropagation()');
      b.appendChild(buttontext(txt));
      b.setAttribute('position',pos);
      // b.setAttribute('rotatePlot','axis:'+ax+';nofWall:'+idx);
      b.addEventListener('mouseenter',function() {
        window.clearInterval(rotate);
        rotate = setInterval(function(){rotatePlot(ax,idx,txt)},100);
      });
      b.addEventListener('mouseleave',function(){
        window.clearInterval(rotate);
      });
      return b;
    };
    function rotatePlot(a,n,d){
      var plot = document.getElementById('plotbox'+n);
      var rot = plot.getAttribute('rotation');
      if (d == '<'){
        rot[a]=rot[a]-1;
      }else if(d=='>'){
        rot[a]=rot[a]+1;
      }
      plot.setAttribute('rotation',rot);
    }
  </script>
  <script> // script for the creation of an octagonal 'room'
    AFRAME.registerComponent('room', {
      init: function () {
        var space = document.querySelector('a-scene');
        var i;
        var w = 10,
          h = 15;
        for (i = 0; i < 8; i++) {
          var sheet = document.createElement('a-entity');
          var alpha = i / 4 * Math.PI;
          sheet.setAttribute('id', 'mycanvas' + i);
          //sheet.setAttribute('class', 'mycanvas');
          sheet.setAttribute('geometry', {
            primitive: 'plane',
            height: h,
            width: w
          });
          sheet.setAttribute('material', {
            metalness: 0,
            color: '#f0f0f0'
          });
          sheet.setAttribute('position', { x: 10 * Math.sin(alpha), y: 1, z: 10 * Math.cos(alpha) });
          sheet.setAttribute('rotation', { x: 0, y: (i - 4) / 8 * 360, z: 0 });
          sheet.setAttribute('buttons', '');
          sheet.setAttribute('value', i);
          space.appendChild(sheet);
        }
      }
    });
  </script>
  <script> // creating teleport options
    AFRAME.registerComponent('tiles',{
      init: function () {
        var m,n;
        var nTiles = 20;
        for (m=0;m<nTiles;m++){
          for (n=0;n<nTiles;n++){
            var tile = document.createElement('a-entity');
            tile.setAttribute('geometry',{primitive:'plane',
              height:1,width:1});
            tile.setAttribute('position',{x:(m-9.5),y:(n-9.5),z:0.01});
            tile.setAttribute('material','opacity',0.2);
            tile.setAttribute('class','clickable');
            if (Math.sqrt((m-9.5)**2+(n-9.5)**2)<10.5) {
              tile.setAttribute('line__l','start:-.5 -.5 0; end:.5 -.5 0;color:black;visible:false');
              tile.setAttribute('line__t','start:.5 -.5 0; end:.5 .5 0;color:black;visible:false');
              tile.setAttribute('line__r','start:.5 .5 0; end:-.5 .5 0;color:black;visible:false');
              tile.setAttribute('line__b','start:-.5 .5 0; end:-.5 -.5 0;color:black;visible:false');
              tile.addEventListener('mouseenter',function() {
                this.setAttribute('line__l','visible:true');
                this.setAttribute('line__t','visible:true');
                this.setAttribute('line__b','visible:true');
                this.setAttribute('line__r','visible:true');
              });
              tile.addEventListener('mouseleave',function() {
                this.setAttribute('line__l','visible:false');
                this.setAttribute('line__t','visible:false');
                this.setAttribute('line__b','visible:false');
                this.setAttribute('line__r','visible:false');
              });
              tile.addEventListener('click',function() {
                var cam = document.getElementById('camera');
                cam.setAttribute('position',{x:this.getAttribute('position').x,y:0,z:-this.getAttribute('position').y});
                console.log(cam.getAttribute('position'));
              });
            }
            var floor = document.getElementById('floor');
            floor.appendChild(tile);
          };
        };
      }
    });
  </script>
  <script> // creating the buttons on the walls
    AFRAME.registerComponent('buttons', {
      init: function () {
        var val = this.el.getAttribute('value');
        var b = ['x', 'y', 'z', 'show', 'hide'];
        var bx = [0.15, 0.775, 0.15, 0.2, 0.8].map(function (x) { return 10 * (x - .5) });
        var by = [0.3, 0.65, 0.7, 0.2, 0.2].map(function (x) { return 15 * (x - .5) });
        for (j = 0; j < 5; j++) {
          var button = document.createElement('a-entity');
          button.setAttribute('id', b[j] + val);
          button.setAttribute('value', b[j]);
          button.setAttribute('geometry', {
            primitive: 'box',
            height: '.5',
            width: '1',
            depth: '.1'
          });
          button.setAttribute('material', 'color', 'grey');
          button.setAttribute('position', { x: bx[j], y: by[j], z: 0 });
          if (b[j]=="x"||b[j]=="y"||b[j]=="z"){
            button.setAttribute('axis_cursorlistener', {axis:b[j],on:false});  
          }else{
            button.setAttribute(b[j] + '_cursorlistener', '');
          }
          button.setAttribute('rotation', { x: 0, y: 0, z: 0 });
          if (j < 3) {
            button.setAttribute('visible', 'false');
          } else {
            button.setAttribute('class', 'clickable');
          }
          var buttontext = document.createElement('a-text');
          buttontext.setAttribute('value', b[j]);
          buttontext.setAttribute('color', 'black');
          buttontext.setAttribute('align', 'center');
          buttontext.setAttribute('position', { x: 0, y: 0, z: .055 });
          button.appendChild(buttontext);
          this.el.appendChild(button);
        }
      }
    });
  </script>
  <script src='https://d3js.org/d3.v4.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js'></script>
</head>
<style>
  text {
    font: 11px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .tick line {
    opacity: 0.2;
  }

  /* .dot {
    fill: crimson;
    stroke: #000;
  } */
</style>

<body>
  <a-scene background='color:#CECECE' room tiles>
    <a-assets>
      <img id='wood' src='1-fine-wood-seamless.jpg'>
      <img id='sky' src='mild800.jpg'>
    </a-assets>
    <a-entity id='camera' camera look-controls wasd-controls>
      <a-entity
        animation__click='property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.5 0.5 0.5; to: 1 1 1'
        animation__fusing='property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.5 0.5 0.5'
        animation__mouseleave='property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1'
        raycaster='objects: .clickable' cursor='fuse:true' position='0 0 -1'
        geometry='primitive:ring; radiusInner:0.02; radiusOuter:0.03' material='color:black; shader:flat'>
      </a-entity>
    </a-entity>
    <a-sky color='skyblue'> </a-sky>
    <a-plane id='floor' src='#wood' position='0 -5 0' height='20' width='20' repeat='10 10' rotation='-90 0 0'></a-plane>
  </a-scene>
  
</body>

</html>
